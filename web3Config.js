// require( 'db.js' );
var etherUnits = require("./lib/etherUnits.js");
var BigNumber = require('bignumber.js');
var Web3 = require('web3');
var _web3;
var _eth;
// var mongoose = require( 'mongoose' );
// var Block     = mongoose.model( 'Block' );

//----------------------config--------------------
var contractBytes = "0x608060405269010f0cf064dd59200000600255600060055561048060405190810160405280600164ffffffffff168152602001600264ffffffffff168152602001600464ffffffffff168152602001600864ffffffffff168152602001601064ffffffffff168152602001602064ffffffffff168152602001604064ffffffffff168152602001608064ffffffffff16815260200161010064ffffffffff16815260200161020064ffffffffff16815260200161040064ffffffffff16815260200161080064ffffffffff16815260200161100064ffffffffff16815260200161200064ffffffffff16815260200161400064ffffffffff16815260200161800064ffffffffff1681526020016201000064ffffffffff1681526020016202000064ffffffffff1681526020016204000064ffffffffff1681526020016208000064ffffffffff1681526020016210000064ffffffffff1681526020016220000064ffffffffff1681526020016240000064ffffffffff1681526020016280000064ffffffffff168152602001630100000064ffffffffff168152602001630200000064ffffffffff168152602001630400000064ffffffffff168152602001630800000064ffffffffff168152602001631000000064ffffffffff168152602001632000000064ffffffffff168152602001634000000064ffffffffff168152602001638000000064ffffffffff16815260200164010000000064ffffffffff16815260200164020000000064ffffffffff16815260200164040000000064ffffffffff16815260200164080000000064ffffffffff1681525060079060246200026c92919062000393565b503480156200027a57600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060093390806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550506002600460006002815260200190815260200160002081905550603e600460006006815260200190815260200160002081905550640ffffffffe600460006024815260200190815260200160002081905550606160046000606481526020019081526020016000208190555062000416565b828054828255906000526020600020908101928215620003db579160200282015b82811115620003da578251829064ffffffffff16905591602001919060010190620003b4565b5b509050620003ea9190620003ee565b5090565b6200041391905b808211156200040f576000816000905550600101620003f5565b5090565b90565b612ddf80620004266000396000f300608060405260043610610107576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630340752f146101095780630d2cbe131461014c57806322af00fa1461018357806341c0e1b51461022757806357246d231461023e5780636e911f931461028d5780637cee9ee8146102ce5780637e0b9eea14610335578063898aab43146103605780638da5cb5b146103ba57806394279f0214610411578063b539cd551461043c578063d06c54fb14610467578063d579fd441461047e578063d6d30a51146104c1578063d9747f58146104ee578063df88126f1461055b578063e1fdb4b4146105aa578063fbd668a9146105d7575b005b34801561011557600080fd5b5061014a600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610604565b005b34801561015857600080fd5b506101816004803603810190808035906020019092919080359060200190929190505050610793565b005b34801561018f57600080fd5b506101ae60048036038101908080359060200190929190505050610a44565b604051808781526020018660ff1660ff1681526020018581526020018464ffffffffff1664ffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001828152602001965050505050505060405180910390f35b34801561023357600080fd5b5061023c610abe565b005b34801561024a57600080fd5b50610253610cd6565b60405180826fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561029957600080fd5b506102b860048036038101908080359060200190929190505050610cf8565b6040518082815260200191505060405180910390f35b61033360048036038101908080359060200190929190803590602001909291908035906020019092919080359060200190929190803560ff16906020019092919080356000191690602001909291908035600019169060200190929190505050610d1b565b005b34801561034157600080fd5b5061034a61166c565b6040518082815260200191505060405180910390f35b34801561036c57600080fd5b506103b8600480360381019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190803560ff169060200190929190505050611672565b005b3480156103c657600080fd5b506103cf611921565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561041d57600080fd5b50610426611946565b6040518082815260200191505060405180910390f35b34801561044857600080fd5b50610451611953565b6040518082815260200191505060405180910390f35b34801561047357600080fd5b5061047c611959565b005b34801561048a57600080fd5b506104bf600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611b30565b005b3480156104cd57600080fd5b506104ec60048036038101908080359060200190929190505050611d23565b005b3480156104fa57600080fd5b5061051960048036038101908080359060200190929190505050612000565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561056757600080fd5b5061057061203e565b60405180826fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156105b657600080fd5b506105d560048036038101908080359060200190929190505050612060565b005b3480156105e357600080fd5b506106026004803603810190808035906020019092919050505061237d565b005b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156106ee576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001807f4f6e6c794f776e6572206d6574686f64732063616c6c6564206279206e6f6e2d81526020017f6f776e65722e000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415151561072a57600080fd5b60098190806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050565b6000806000806000809150600090505b600980549050811015610833576009818154811015156107bf57fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156108265760019150610833565b80806001019150506107a3565b81151561083f57600080fd5b86604051602001808281526020019150506040516020818303038152906040526040518082805190602001908083835b602083101515610894578051825260208201915060208101905060208303925061086f565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600190049450600860008681526020019081526020016000209350836002015492508243111515610980576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260338152602001807f736574746c6542657420696e207468652073616d6520626c6f636b206173207081526020017f6c6163654265742c206f72206265666f72652e0000000000000000000000000081525060400191505060405180910390fd5b607883014311151515610a21576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001807f426c6f636b686173682063616e2774206265207175657269656420627920455681526020017f4d2e00000000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b8583141515610a2f57600080fd5b610a3b85858989612519565b50505050505050565b60086020528060005260406000206000915090508060000154908060010160009054906101000a900460ff16908060020154908060030160009054906101000a900464ffffffffff16908060030160059054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060040154905086565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610ba8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001807f4f6e6c794f776e6572206d6574686f64732063616c6c6564206279206e6f6e2d81526020017f6f776e65722e000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b6000600360109054906101000a90046fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff16141515610c9c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260488152602001807f416c6c20626574732073686f756c642062652070726f6365737365642028736581526020017f74746c6564206f7220726566756e64656429206265666f72652073656c662d6481526020017f657374727563742e00000000000000000000000000000000000000000000000081525060600191505060405180910390fd5b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b600360009054906101000a90046fffffffffffffffffffffffffffffffff1681565b600681815481101515610d0757fe5b906000526020600020016000915090505481565b6000806000806000600860008a81526020019081526020016000209450600073ffffffffffffffffffffffffffffffffffffffff168560030160059054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141515610e26576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260218152602001807f4265742073686f756c6420626520696e20612027636c65616e2720737461746581526020017f2e0000000000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b34935060018b118015610e3a575060648b11155b1515610eae576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f4d6f64756c6f2073686f756c642062652077697468696e2072616e67652e000081525060200191505060405180910390fd5b678ac7230489e800008410158015610ed0575069010f0cf064dd592000008411155b1515610f44576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f416d6f756e742073686f756c642062652077697468696e2072616e67652e000081525060200191505060405180910390fd5b60008c118015610f675750600460008c8152602001908152602001600020548c11155b1515610fdb576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601c8152602001807f4d61736b2073686f756c642062652077697468696e2072616e67652e0000000081525060200191505060405180910390fd5b894311151515611053576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260138152602001807f436f6d6d69742068617320657870697265642e0000000000000000000000000081525060200191505060405180910390fd5b60016040805190810160405280601c81526020017f19457468657265756d205369676e6564204d6573736167653a0a3332000000008152508b8b60405160200180838152602001828152602001925050506040516020818303038152906040526040518082805190602001908083835b6020831015156110e857805182526020820191506020810190506020830392506110c3565b6001836020036101000a03801982511681845116808217855250505050505090500191505060405180910390206040516020018083805190602001908083835b60208310151561114d5780518252602082019150602081019050602083039250611128565b6001836020036101000a0380198251168184511680821785525050505050509050018260001916600019168152602001925050506040516020818303038152906040526040518082805190602001908083835b6020831015156111c557805182526020820191506020810190506020830392506111a0565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020898989604051600081526020016040526040518085600019166000191681526020018460ff1660ff1681526020018360001916600019168152602001826000191660001916815260200194505050505060206040516020810390808403906000865af1158015611266573d6000803e3d6000fd5b50505060206040510351925061127b836129af565b15156112ef576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601d8152602001807f4543445341207369676e6174757265206973206e6f742076616c69642e00000081525060200191505060405180910390fd5b6112fa848c8e612a56565b80925081935050506002548401821115151561137e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601a8152602001807f6d617850726f666974206c696d69742076696f6c6174696f6e2e00000000000081525060200191505060405180910390fd5b81600360108282829054906101000a90046fffffffffffffffffffffffffffffffff160192506101000a8154816fffffffffffffffffffffffffffffffff02191690836fffffffffffffffffffffffffffffffff16021790555080600360008282829054906101000a90046fffffffffffffffffffffffffffffffff160192506101000a8154816fffffffffffffffffffffffffffffffff02191690836fffffffffffffffffffffffffffffffff1602179055503073ffffffffffffffffffffffffffffffffffffffff1631600360109054906101000a90046fffffffffffffffffffffffffffffffff16600360009054906101000a90046fffffffffffffffffffffffffffffffff16016fffffffffffffffffffffffffffffffff1611151515611511576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f43616e6e6f74206166666f726420746f206c6f73652074686973206265742e0081525060200191505060405180910390fd5b8385600001819055508a8560010160006101000a81548160ff021916908360ff1602179055504385600201819055508b8560030160006101000a81548164ffffffffff021916908364ffffffffff160217905550338560030160056101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508185600401819055506005600081548092919060010191905055508460010160009054906101000a900460ff1660ff163373ffffffffffffffffffffffffffffffffffffffff168a7fcd3f64138f645ba9a63e71a378025bfda5a3d31f1e25bb744fc90e7cf6fdc7a88860030160009054906101000a900464ffffffffff16888a60020154604051808464ffffffffff1664ffffffffff168152602001838152602001828152602001935050505060405180910390a4505050505050505050505050565b60055481565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561175c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001807f4f6e6c794f776e6572206d6574686f64732063616c6c6564206279206e6f6e2d81526020017f6f776e65722e000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b60008160ff16141561177957611773838384612c4b565b5061191c565b3073ffffffffffffffffffffffffffffffffffffffff1631821115151561182e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260248152602001807f496e63726561736520616d6f756e74206c6172676572207468616e2062616c6181526020017f6e63652e0000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b3073ffffffffffffffffffffffffffffffffffffffff163182600360109054906101000a90046fffffffffffffffffffffffffffffffff16600360009054906101000a90046fffffffffffffffffffffffffffffffff16016fffffffffffffffffffffffffffffffff16011115151561190f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260118152602001807f4e6f7420656e6f7567682066756e64732e00000000000000000000000000000081525060200191505060405180910390fd5b61191a838384612c4b565b505b505050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600680549050905090565b60025481565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515611a44576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001807f43616e206f6e6c792061636365707420707265617070726f766564206e65772081526020017f6f776e65722e000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506009600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515611c1a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001807f4f6e6c794f776e6572206d6574686f64732063616c6c6564206279206e6f6e2d81526020017f6f776e65722e000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614151515611cdf576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601d8152602001807f43616e6e6f7420617070726f76652063757272656e74206f776e65722e00000081525060200191505060405180910390fd5b80600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515611e0d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001807f4f6e6c794f776e6572206d6574686f64732063616c6c6564206279206e6f6e2d81526020017f6f776e65722e000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b3073ffffffffffffffffffffffffffffffffffffffff16318111151515611ec2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260248152602001807f496e63726561736520616d6f756e74206c6172676572207468616e2062616c6181526020017f6e63652e0000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b3073ffffffffffffffffffffffffffffffffffffffff163181600360109054906101000a90046fffffffffffffffffffffffffffffffff16600360009054906101000a90046fffffffffffffffffffffffffffffffff16016fffffffffffffffffffffffffffffffff160111151515611fa3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260118152602001807f4e6f7420656e6f7567682066756e64732e00000000000000000000000000000081525060200191505060405180910390fd5b80600360008282829054906101000a90046fffffffffffffffffffffffffffffffff160192506101000a8154816fffffffffffffffffffffffffffffffff02191690836fffffffffffffffffffffffffffffffff16021790555050565b60098181548110151561200f57fe5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600360109054906101000a90046fffffffffffffffffffffffffffffffff1681565b6000806000806000806000600860008981526020019081526020016000209650607887600201540143111515612124576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001807f426c6f636b686173682063616e2774206265207175657269656420627920455681526020017f4d2e00000000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b86600001549550600086141515156121ca576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001807f4265742073686f756c6420626520696e20616e2027616374697665272073746181526020017f746500000000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b600087600001819055508660040154945060008514156121e8578594505b6122178760030160059054906101000a900473ffffffffffffffffffffffffffffffffffffffff168687612c4b565b935083156123695784600360108282829054906101000a90046fffffffffffffffffffffffffffffffff160392506101000a8154816fffffffffffffffffffffffffffffffff02191690836fffffffffffffffffffffffffffffffff160217905550600680549050925060009150600090505b82811015612314576006818154811015156122a157fe5b90600052602060002001548814156122b857600191505b8180156122c757506001830381105b15612307576006600182018154811015156122de57fe5b90600052602060002001546006828154811015156122f857fe5b90600052602060002001819055505b808060010191505061228a565b81156123515760066001840381548110151561232c57fe5b9060005260206000200160009055600680548091906001900361234f9190612d62565b505b60056000815480929190600190039190505550612373565b8587600001819055505b5050505050505050565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515612467576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001807f4f6e6c794f776e6572206d6574686f64732063616c6c6564206279206e6f6e2d81526020017f6f776e65722e000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b69010f0cf064dd59200000811115151561250f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001807f6d617850726f6669742073686f756c6420626520612073616e65206e756d626581526020017f722e00000000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b8060028190555050565b60008060008060008060008060008b60010160009054906101000a900460ff1660ff16985060008c60000154141515156125e1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001807f4265742073686f756c6420626520696e20616e2027616374697665272073746181526020017f746500000000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b8a8a40604051602001808381526020018260001916600019168152602001925050506040516020818303038152906040526040518082805190602001908083835b6020831015156126475780518252602082019150602081019050602083039250612622565b6001836020036101000a0380198251168184511680821785525050505050509050019150506040518091039020600190049750888881151561268557fe5b0696506126b38c600001548a8e60030160009054906101000a900464ffffffffff1664ffffffffff16612a56565b809650819750505060009350600092506028891115156127015760008c60030160009054906101000a900464ffffffffff1664ffffffffff168860020a161415156126fc578593505b61272a565b8b60030160009054906101000a900464ffffffffff1664ffffffffff16871015612729578593505b5b68056bc75e2d631000008c600001541015156127d4576103e8898981151561274e57fe5b0481151561275857fe5b0691506103788214156127d357600360009054906101000a90046fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff1692506000600360006101000a8154816fffffffffffffffffffffffffffffffff02191690836fffffffffffffffffffffffffffffffff1602179055505b5b6000838501146127e6578284016127e9565b60015b90508b60030160059054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f193505050501561293e5760008c6000018190555085600360108282829054906101000a90046fffffffffffffffffffffffffffffffff160392506101000a8154816fffffffffffffffffffffffffffffffff02191690836fffffffffffffffffffffffffffffffff160217905550808c60030160059054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168e7f6e73056f04e59b9775a04fe9801a805fbf3172ed588c7168fcc021c00ea75f79878f8d8d6040518085815260200184815260200183815260200182815260200194505050505060405180910390a461298d565b600181111561298157808c6004018190555060068d908060018154018082558091505090600182039060005260206000200160009091929091909150555061298c565b60008c600001819055505b5b6005600081548092919060019003919050555050505050505050505050505050565b6000806000809150600090505b600980549050811015612a4c576009818154811015156129d857fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161415612a3f5760019150612a4c565b80806001019150506129bc565b8192505050919050565b60008060008060008086118015612a80575060046000888152602001908152602001600020548611155b1515612af4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601d8152602001807f57696e2070726f626162696c697479206f7574206f662072616e67652e00000081525060200191505060405180910390fd5b68056bc75e2d63100000881015612b0c576000612b16565b670de0b6b3a76400005b935060009250602887111515612b9857600091505b6007805490508260ff161015612b935760078260ff16815481101515612b4d57fe5b90600052602060002001548660078460ff16815481101515612b6b57fe5b9060005260206000200154161415612b865782806001019350505b8180600101925050612b2b565b612b9c565b8592505b60009050680340aad21b3b700000881015612bd5576064600284898b02811515612bc257fe5b0402811515612bcd57fe5b049050612c2c565b68056bc75e2d63100000881015612c0a576064600184898b02811515612bf757fe5b0402811515612c0257fe5b049050612c2b565b6103e8600584898b02811515612c1c57fe5b0402811515612c2757fe5b0490505b5b838184898b02811515612c3b57fe5b0403039450505050935093915050565b600080600090508473ffffffffffffffffffffffffffffffffffffffff166108fc859081150290604051600060405180830381858888f1935050505015612d0857600190507f9643c1b5b172b26d5f028be7fe646349bd5e3cd9367bb18f9e825afa828b7d93858585604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001838152602001828152602001935050505060405180910390a1612d57565b8473ffffffffffffffffffffffffffffffffffffffff167fac464fe4d3a86b9121261ac0a01dd981bfe0777c7c9d9c8f4473d31a9c0f9d2d856040518082815260200191505060405180910390a25b809150509392505050565b815481835581811115612d8957818360005260206000209182019101612d889190612d8e565b5b505050565b612db091905b80821115612dac576000816000905550600101612d94565b5090565b905600a165627a7a72305820ffe72b37b4641c0c97b02a328662aa75e61845aab111171e75271c70e74971770029";

var petContractABI = [{"constant":false,"inputs":[],"name":"acceptNextOwner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_newCOO","type":"address"}],"name":"addCOO","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_nextOwner","type":"address"}],"name":"approveNextOwner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"increaseAmount","type":"uint256"}],"name":"increaseJackpot","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"kill","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"betMask","type":"uint256"},{"name":"modulo","type":"uint256"},{"name":"commitLastBlock","type":"uint256"},{"name":"commit","type":"uint256"},{"name":"v","type":"uint8"},{"name":"r","type":"bytes32"},{"name":"s","type":"bytes32"}],"name":"placeBet","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"commit","type":"uint256"}],"name":"refundBet","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_maxProfit","type":"uint256"}],"name":"setMaxProfit","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"reveal","type":"uint256"},{"name":"placeBlockNum","type":"uint256"}],"name":"settleBet","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"beneficiary","type":"address"},{"name":"withdrawAmount","type":"uint256"},{"name":"safe","type":"uint8"}],"name":"withdrawFunds","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"commit","type":"uint256"},{"indexed":true,"name":"gambler","type":"address"},{"indexed":true,"name":"modulo","type":"uint8"},{"indexed":false,"name":"mask","type":"uint40"},{"indexed":false,"name":"amount","type":"uint256"},{"indexed":false,"name":"playceBlock","type":"uint256"}],"name":"OnPlaceBet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"beneficiary","type":"address"},{"indexed":false,"name":"amount","type":"uint256"}],"name":"FailedPayment","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"beneficiary","type":"address"},{"indexed":false,"name":"totalAmount","type":"uint256"},{"indexed":false,"name":"amount","type":"uint256"}],"name":"Payment","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"commit","type":"uint256"},{"indexed":true,"name":"gambler","type":"address"},{"indexed":true,"name":"totalAmount","type":"uint256"},{"indexed":false,"name":"amount","type":"uint256"},{"indexed":false,"name":"reveal","type":"uint256"},{"indexed":false,"name":"entropy","type":"uint256"},{"indexed":false,"name":"dice","type":"uint256"}],"name":"SettleBetPayment","type":"event"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"cooAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"dealFailList","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"dealFailNum","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"jackpotSize","outputs":[{"name":"","type":"uint128"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"lockedInBets","outputs":[{"name":"","type":"uint128"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"maxProfit","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"undealBetNum","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}];

var debugMode = true;//是否为调试模式，调试模式将强制使用本地节点

var MaxEstimateGas = 3700000;//通过多次交易测试后选最大的gas
var contractAddress = null;//;//为null时可以通过deployContract请求来部署
var SecretSigner = "0xeb0e5b3c177c72235d07d8daa6e7ad8fe701e24a";
// var Croupier = "0xeb0e5b3c177c72235d07d8daa6e7ad8fe701e24a";//相当于COO
//代理商信息，第一个代理商同时也是合约发布者
var delegates = [];
// delegates.push({"account":"0xeb0e5b3c177c72235d07d8daa6e7ad8fe701e24a", "latestNonce":-1, "privateKey":new Buffer('a6abcae8af8089b782b90ee864da0912320d31a83306b740d1a843108e8cfa9f', 'hex'), privateKeyStr:'0xa6abcae8af8089b782b90ee864da0912320d31a83306b740d1a843108e8cfa9f'});
// delegates.push({"account":"0xc17f762282149f36f2b26bfee54aa8678b70c3a4", "latestNonce":-1, "privateKey":new Buffer('ef28d75985db54e454ae37882aeb0f8850f35f15c5d42f2c82e8cde277a1f5f0', 'hex'), privateKeyStr:'0xef28d75985db54e454ae37882aeb0f8850f35f15c5d42f2c82e8cde277a1f5f0'});
// delegates.push({"account":"0x5b1b048bac797bd17d5c9eb04e575960ec25ed02", "latestNonce":-1, "privateKey":new Buffer('69a5f349e11d11ca0bc15c53a3b87443d20347daf7ca4ff7d7c286c3e8750391', 'hex'), privateKeyStr:'0x69a5f349e11d11ca0bc15c53a3b87443d20347daf7ca4ff7d7c286c3e8750391'});
delegates.push({"account":"0x235fea5ea4b0ce72b97430972ef77a8d93956a73", "latestNonce":-1, "privateKey":new Buffer('1F8CAE4D8604D6FE204789EB7430646D59B0BCD8E5C15D801D88273E39AD4978', 'hex'), privateKeyStr:'0x1F8CAE4D8604D6FE204789EB7430646D59B0BCD8E5C15D801D88273E39AD4978'});
delegates.push({"account":"0xd944e7a9f9bfcf28410e3de204d5cbbab58bac37", "latestNonce":-1, "privateKey":new Buffer('23F6C27FA7E4FBCD8C971B17E6F7FAD9F1A64A3BF06E0588B604C1BA1D2A5E14', 'hex'), privateKeyStr:'0x23F6C27FA7E4FBCD8C971B17E6F7FAD9F1A64A3BF06E0588B604C1BA1D2A5E14'});
delegates.push({"account":"0x1ccb0a84e2ea1fe3f096a0aa395dce19b00e5f7a", "latestNonce":-1, "privateKey":new Buffer('B38B46DF7AEB71E4879365D3FA2ECE64DEA3F39DF4A809BF908EB70EEF1623EA', 'hex'), privateKeyStr:'0xB38B46DF7AEB71E4879365D3FA2ECE64DEA3F39DF4A809BF908EB70EEF1623EA'});

//-----------------------------------------------
var petContract;
var subContract;

var startWeb3 = async function(cb) {
    var rpcURL;
    //为调试与发布模式强制设置一些值方便测试与提高安全性
    if(debugMode){
      // contractAddress = "0x740b88316c6a3b2738de91cf046c48da746ff0fe"; //2019.5.11
      // contractAddress="0xcb826cb2e45215fdd57552ceecd7369307af6d74"
        // contractAddress="0x1B8356E2EA33aEb90eA80439630E5a07C1678542";
        rpcURL = 'http://localhost:9646';
        // contractAddress="0x5d478631823cef55441bc71e4365a1836d1e4cbd";//t
        // rpcURL = 'http://etzrpc.org:80';//t
    }else{
        contractAddress="0x5137814e854fa10ee6d8ac3ad836d345db6ed44e";
        rpcURL = 'http://localhost:9646';
        // contractAddress="0x5d478631823cef55441bc71e4365a1836d1e4cbd";//t
        // rpcURL = 'http://etzrpc.org:80';//t
    }
    var  _web3 = new Web3(new Web3.providers.HttpProvider(rpcURL));
    // var _web3WS = new Web3(new Web3.providers.WebsocketProvider(_wsProvider));
    eth = _web3.eth;

    //有合约地址则获取合约实例，没有则通过deployContract接口部署，或者setContractAddr接口设置已有合约
    if(contractAddress!=null){
        petContract = new eth.Contract(petContractABI, contractAddress);
        try{
            var maxProfit = await petContract.methods.maxProfit().call();
            console.log(maxProfit);
        }catch(err){
            petContract = null;
            contractAddress = null;
        }
    }
    module.exports.contractAddress = contractAddress;

    //读取区块链上的nonce
    for(var i=0; i<delegates.length; i++){
        delegates[i].latestNonce = await eth.getTransactionCount(delegates[i].account)-1;
        console.log(delegates[i].account,' latestNonce:'+delegates[i].latestNonce);
    }


    module.exports.web3 = _web3;
    module.exports.petContract = petContract;
    module.exports.delegates = delegates;
    console.log('web3 start!');

    cb();
}

module.exports.startWeb3 = startWeb3;
module.exports.debugMode = debugMode;
module.exports.petContractABI = petContractABI;
module.exports.contractBytes = contractBytes;
module.exports.SecretSigner = SecretSigner;
// module.exports.Croupier = Croupier;
module.exports.MaxEstimateGas = MaxEstimateGas;
