// require( 'db.js' );
var etherUnits = require("./lib/etherUnits.js");
var BigNumber = require('bignumber.js');
var Web3 = require('web3');
var _web3;
var _eth;
// var mongoose = require( 'mongoose' );
// var Block     = mongoose.model( 'Block' );

//----------------------config--------------------
var contractBytes = "0x69010f0cf064dd592000006003556000600655610500604090815260016080908152600260a052600460c052600860e0819052601061010090815260206101205261014093909352610160829052610180929092526102006101a08190526104006101c08190526108006101e0526110009091526120006102205261400061024052618000610260526201000061028052620200006102a052620400006102c052620800006102e052621000006103005262200000610320526240000061034052628000006103605263010000006103805263020000006103a05263040000006103c05263080000006103e05263100000009052632000000061042052634000000061044052638000000061046052640100000000610480526402000000006104a0526404000000006104c0526408000000006104e052620001449190602462000240565b503480156200015257600080fd5b506000805433600160a060020a031991821681178355600a8054600181019091557fc65a7bb8d6351c1cf70c95a316cc6a92839c986682d98bc35f958f4883f9d2a8018054909216179055600560205260027f89832631fb3c3307a103ba2c84ab569c64d6182a18893dcd163f0f1c2090733a55603e7f069400f22b28c6c362558d92f66163cec5671cba50b61abd2eecfcd0eaeac51855640ffffffffe7f4d86b00d2ea4cfb01847b7956081673f71c56ef4a250d3ffa5902b0df4fc9706556064905260617fad66b8e7ab72f450ddfdaf1c5bc10e3a3fabf9f63ad8aa07b8743b93722f0a4555620002b9565b82805482825590600052602060002090810192821562000287579160200282015b8281111562000287578251829064ffffffffff1690559160200191906001019062000261565b506200029592915062000299565b5090565b620002b691905b80821115620002955760008155600101620002a0565b90565b611e7e80620002c96000396000f30060806040526004361061011c5763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416630340752f811461011e5780630d2cbe131461013f57806322af00fa1461015a57806341c0e1b5146101b65780634d61537f146101cb57806357246d23146101fc5780636e911f931461022d5780637cee9ee8146102575780637e0b9eea14610277578063898aab431461028c5780638da5cb5b146102b657806394279f02146102cb578063b539cd55146102e0578063d06c54fb146102f5578063d579fd441461030a578063d6d30a511461032b578063d702087f14610343578063d9747f5814610364578063df88126f1461037c578063e1fdb4b414610391578063fbd668a9146103a9575b005b34801561012a57600080fd5b5061011c600160a060020a03600435166103c1565b34801561014b57600080fd5b5061011c600435602435610497565b34801561016657600080fd5b506101726004356106a4565b6040805196875260ff90951660208701528585019390935264ffffffffff9091166060850152600160a060020a0316608084015260a0830152519081900360c00190f35b3480156101c257600080fd5b5061011c6106f3565b3480156101d757600080fd5b506101e0610817565b60408051600160a060020a039092168252519081900360200190f35b34801561020857600080fd5b50610211610826565b604080516001608060020a039092168252519081900360200190f35b34801561023957600080fd5b50610245600435610835565b60408051918252519081900360200190f35b61011c60043560243560443560643560ff6084351660a43560c435610854565b34801561028357600080fd5b50610245610eee565b34801561029857600080fd5b5061011c600160a060020a036004351660243560ff60443516610ef4565b3480156102c257600080fd5b506101e061107a565b3480156102d757600080fd5b50610245611089565b3480156102ec57600080fd5b50610245611090565b34801561030157600080fd5b5061011c611096565b34801561031657600080fd5b5061011c600160a060020a0360043516611175565b34801561033757600080fd5b5061011c60043561126c565b34801561034f57600080fd5b5061011c600160a060020a03600435166113f5565b34801561037057600080fd5b506101e0600435611486565b34801561038857600080fd5b506102116114ae565b34801561039d57600080fd5b5061011c6004356114c4565b3480156103b557600080fd5b5061011c600435611775565b600054600160a060020a03163314610423576040805160e560020a62461bcd0281526020600482015260266024820152600080516020611e33833981519152604482015260d160020a6537bbb732b91702606482015290519081900360840190fd5b600160a060020a038116151561043857600080fd5b600a80546001810182556000919091527fc65a7bb8d6351c1cf70c95a316cc6a92839c986682d98bc35f958f4883f9d2a801805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b6000808080805b600a548110156104e357600a8054829081106104b657fe5b600091825260209091200154600160a060020a03163314156104db57600191506104e3565b60010161049e565b8115156104ef57600080fd5b86604051602001808281526020019150506040516020818303038152906040526040518082805190602001908083835b6020831061053e5780518252601f19909201916020918201910161051f565b51815160001960209485036101000a0190811690199190911617905260408051949092018490039093206000818152600990945292206002810154929950975090955050504384109050610602576040805160e560020a62461bcd02815260206004820152603360248201527f736574746c6542657420696e207468652073616d6520626c6f636b206173207060448201527f6c6163654265742c206f72206265666f72652e00000000000000000000000000606482015290519081900360840190fd5b60788301431115610683576040805160e560020a62461bcd02815260206004820152602260248201527f426c6f636b686173682063616e2774206265207175657269656420627920455660448201527f4d2e000000000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b82861461068f57600080fd5b61069b85858989611864565b50505050505050565b60096020526000908152604090208054600182015460028301546003840154600490940154929360ff90921692909164ffffffffff81169165010000000000909104600160a060020a03169086565b600054600160a060020a03163314610755576040805160e560020a62461bcd0281526020600482015260266024820152600080516020611e33833981519152604482015260d160020a6537bbb732b91702606482015290519081900360840190fd5b600454608060020a90046001608060020a031615610809576040805160e560020a62461bcd02815260206004820152604860248201527f416c6c20626574732073686f756c642062652070726f6365737365642028736560448201527f74746c6564206f7220726566756e64656429206265666f72652073656c662d6460648201527f657374727563742e000000000000000000000000000000000000000000000000608482015290519081900360a40190fd5b600054600160a060020a0316ff5b600254600160a060020a031681565b6004546001608060020a031681565b600780548290811061084357fe5b600091825260209091200154905081565b6000848152600960205260408120600381015490919081908190650100000000009004600160a060020a0316156108fb576040805160e560020a62461bcd02815260206004820152602160248201527f4265742073686f756c6420626520696e20612027636c65616e2720737461746560448201527f2e00000000000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b34925060018a11801561090f575060648a11155b1515610965576040805160e560020a62461bcd02815260206004820152601e60248201527f4d6f64756c6f2073686f756c642062652077697468696e2072616e67652e0000604482015290519081900360640190fd5b678ac7230489e800008310158015610987575069010f0cf064dd592000008311155b15156109dd576040805160e560020a62461bcd02815260206004820152601e60248201527f416d6f756e742073686f756c642062652077697468696e2072616e67652e0000604482015290519081900360640190fd5b60008b1180156109fb575060008a8152600560205260409020548b11155b1515610a51576040805160e560020a62461bcd02815260206004820152601c60248201527f4d61736b2073686f756c642062652077697468696e2072616e67652e00000000604482015290519081900360640190fd5b884311158015610a645750884361012c01115b1515610aba576040805160e560020a62461bcd02815260206004820152601360248201527f436f6d6d69742068617320657870697265642e00000000000000000000000000604482015290519081900360640190fd5b60016040805190810160405280601c81526020017f19457468657265756d205369676e6564204d6573736167653a0a3332000000008152508a8a60405160200180838152602001828152602001925050506040516020818303038152906040526040518082805190602001908083835b60208310610b495780518252601f199092019160209182019101610b2a565b51815160209384036101000a6000190180199092169116179052604051919093018190038120865190955090830193508392860191508083835b60208310610ba25780518252601f199092019160209182019101610b83565b51815160209384036101000a600019018019909216911617905292019384525060408051808503815293820190819052835193945092839250908401908083835b60208310610c025780518252601f199092019160209182019101610be3565b51815160209384036101000a60001901801990921691161790526040805192909401829003822060008084528383018087529190915260ff8f1683860152606083018e9052608083018d9052935160a08084019750919550601f1981019492819003909101925090865af1158015610c7e573d6000803e3d6000fd5b5050604051601f190151600254600160a060020a039081169116149050610ca457600080fd5b610caf838b8d611bd5565b60035491935091508301821115610d10576040805160e560020a62461bcd02815260206004820152601a60248201527f6d617850726f666974206c696d69742076696f6c6174696f6e2e000000000000604482015290519081900360640190fd5b600480546001608060020a03608060020a808304821686018216810292821692909217808216850182166fffffffffffffffffffffffffffffffff19919091161792839055303183821692909304811691909101161115610dbb576040805160e560020a62461bcd02815260206004820152601f60248201527f43616e6e6f74206166666f726420746f206c6f73652074686973206265742e00604482015290519081900360640190fd5b828460000181905550898460010160006101000a81548160ff021916908360ff1602179055504384600201819055508a8460030160006101000a81548164ffffffffff021916908364ffffffffff160217905550338460030160056101000a815481600160a060020a030219169083600160a060020a031602179055508184600401819055506006600081548092919060010191905055508360010160009054906101000a900460ff1660ff1633600160a060020a0316897fcd3f64138f645ba9a63e71a378025bfda5a3d31f1e25bb744fc90e7cf6fdc7a88760030160009054906101000a900464ffffffffff16878960020154604051808464ffffffffff1664ffffffffff168152602001838152602001828152602001935050505060405180910390a45050505050505050505050565b60065481565b600054600160a060020a03163314610f56576040805160e560020a62461bcd0281526020600482015260266024820152600080516020611e33833981519152604482015260d160020a6537bbb732b91702606482015290519081900360840190fd5b60ff81161515610f7157610f6b838384611d2c565b50611075565b3031821115610fef576040805160e560020a62461bcd028152602060048201526024808201527f496e63726561736520616d6f756e74206c6172676572207468616e2062616c6160448201527f6e63652e00000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b60045430316001608060020a03808316608060020a90930481169290920190911683011115611068576040805160e560020a62461bcd02815260206004820152601160248201527f4e6f7420656e6f7567682066756e64732e000000000000000000000000000000604482015290519081900360640190fd5b611073838384611d2c565b505b505050565b600054600160a060020a031681565b6007545b90565b60035481565b600154600160a060020a0316331461110a576040805160e560020a62461bcd02815260206004820152602660248201527f43616e206f6e6c792061636365707420707265617070726f766564206e657720604482015260d160020a6537bbb732b91702606482015290519081900360840190fd5b600180546000805473ffffffffffffffffffffffffffffffffffffffff19908116600160a060020a039093169283178255600a805494850181559091527fc65a7bb8d6351c1cf70c95a316cc6a92839c986682d98bc35f958f4883f9d2a89092018054909216179055565b600054600160a060020a031633146111d7576040805160e560020a62461bcd0281526020600482015260266024820152600080516020611e33833981519152604482015260d160020a6537bbb732b91702606482015290519081900360840190fd5b600054600160a060020a038281169116141561123d576040805160e560020a62461bcd02815260206004820152601d60248201527f43616e6e6f7420617070726f76652063757272656e74206f776e65722e000000604482015290519081900360640190fd5b6001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b600054600160a060020a031633146112ce576040805160e560020a62461bcd0281526020600482015260266024820152600080516020611e33833981519152604482015260d160020a6537bbb732b91702606482015290519081900360840190fd5b303181111561134c576040805160e560020a62461bcd028152602060048201526024808201527f496e63726561736520616d6f756e74206c6172676572207468616e2062616c6160448201527f6e63652e00000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b60045430316001608060020a03808316608060020a909304811692909201909116820111156113c5576040805160e560020a62461bcd02815260206004820152601160248201527f4e6f7420656e6f7567682066756e64732e000000000000000000000000000000604482015290519081900360640190fd5b600480546fffffffffffffffffffffffffffffffff1981166001608060020a039182169390930116919091179055565b600054600160a060020a03163314611457576040805160e560020a62461bcd0281526020600482015260266024820152600080516020611e33833981519152604482015260d160020a6537bbb732b91702606482015290519081900360840190fd5b6002805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b600a80548290811061149457fe5b600091825260209091200154600160a060020a0316905081565b600454608060020a90046001608060020a031681565b60008181526009602052604081206002810154909190819081908190819081906078014311611563576040805160e560020a62461bcd02815260206004820152602260248201527f426c6f636b686173682063616e2774206265207175657269656420627920455660448201527f4d2e000000000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b865495508515156115e4576040805160e560020a62461bcd02815260206004820152602260248201527f4265742073686f756c6420626520696e20616e2027616374697665272073746160448201527f7465000000000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b60008755600487015494508415156115fa578594505b600387015461161c90650100000000009004600160a060020a03168780611d2c565b93508315611767575050600480546001608060020a03608060020a80830482168790038216029116179055506007546000805b828110156116d057600780548290811061166557fe5b906000526020600020015488141561167c57600191505b81801561168b57506001830381105b156116c85760078054600183019081106116a157fe5b90600052602060002001546007828154811015156116bb57fe5b6000918252602090912001555b60010161164f565b8115611708576007805460001985019081106116e857fe5b60009182526020822001556007805490611706906000198301611df5565b505b60038701546040805187815290518892600160a060020a036501000000000090910416918b917f83798b5c761afdb819ea1f3ccab12f29f98ed03b67b599c0570c03d36259a07e9181900360200190a46006805460001901905561176b565b8587555b5050505050505050565b600054600160a060020a031633146117d7576040805160e560020a62461bcd0281526020600482015260266024820152600080516020611e33833981519152604482015260d160020a6537bbb732b91702606482015290519081900360840190fd5b69010f0cf064dd5920000081111561185f576040805160e560020a62461bcd02815260206004820152602260248201527f6d617850726f6669742073686f756c6420626520612073616e65206e756d626560448201527f722e000000000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b600355565b6001830154835460ff90911690600090819081908190819081908190819015156118fe576040805160e560020a62461bcd02815260206004820152602260248201527f4265742073686f756c6420626520696e20616e2027616374697665272073746160448201527f7465000000000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b6040805160208082018e90528c408284015260018d014060608084019190915283518084039091018152608090920192839052815191929182918401908083835b6020831061195e5780518252601f19909201916020918201910161193f565b5181516020939093036101000a600019018019909116921691909117905260405192018290039091209a508b92508a91505081151561199957fe5b8d5460038f01549290910698506119b8918b9064ffffffffff16611bd5565b909650945060009350839250602889116119ec5760038c0154600288900a1664ffffffffff16156119e7578593505b611a03565b60038c015464ffffffffff16871015611a03578593505b8b5468056bc75e2d6310000011611a60576103e88989811515611a2257fe5b04811515611a2c57fe5b069150610378821415611a6057600480546fffffffffffffffffffffffffffffffff1981169091556001608060020a031692505b83830115611a7057828401611a73565b60015b60038d0154604051919250650100000000009004600160a060020a0316906108fc8315029083906000818181858888f1935050505015611b6d5760008c6000018190555085600460108282829054906101000a90046001608060020a03160392506101000a8154816001608060020a0302191690836001608060020a03160217905550808c60030160059054906101000a9004600160a060020a0316600160a060020a03168e7f6e73056f04e59b9775a04fe9801a805fbf3172ed588c7168fcc021c00ea75f79878f8d8d6040518085815260200184815260200183815260200182815260200194505050505060405180910390a4611bbc565b6001811115611bb75760048c01819055600780546001810182556000919091527fa66cc928b5edb82af9bd49922954155ab7b0942694bea4ce44661d9a8736c688018d9055611bbc565b60008c555b5050600680546000190190555050505050505050505050565b60008060008060008086118015611bfa57506000878152600560205260409020548611155b1515611c50576040805160e560020a62461bcd02815260206004820152601d60248201527f57696e2070726f626162696c697479206f7574206f662072616e67652e000000604482015290519081900360640190fd5b68056bc75e2d63100000881015611c68576000611c72565b670de0b6b3a76400005b93506000925060288711611cea57600091505b60085460ff83161015611ce5576008805460ff8416908110611ca357fe5b90600052602060002001548660088460ff16815481101515611cc157fe5b9060005260206000200154161415611cda576001909201915b600190910190611c85565b611cee565b8592505b606483888a02811515611cfd57fe5b04600202811515611d0a57fe5b049050838184898b02811515611d1c57fe5b0403039450505050935093915050565b6040516000908190600160a060020a0386169085156108fc0290869084818181858888f1935050505015611dad575060408051600160a060020a03861681526020810185905280820184905290516001917f9643c1b5b172b26d5f028be7fe646349bd5e3cd9367bb18f9e825afa828b7d93919081900360600190a1611ded565b604080518581529051600160a060020a038716917fac464fe4d3a86b9121261ac0a01dd981bfe0777c7c9d9c8f4473d31a9c0f9d2d919081900360200190a25b949350505050565b8154818355818111156110755760008381526020902061107591810190830161108d91905b80821115611e2e5760008155600101611e1a565b509056004f6e6c794f776e6572206d6574686f64732063616c6c6564206279206e6f6e2da165627a7a72305820aea7cf63f1766a0c446d97b634341a31ebbd2fb8b7bb2d870a52325a842961cf0029";

var petContractABI = [
	{
		"constant": false,
		"inputs": [
			{
				"name": "_newCOO",
				"type": "address"
			}
		],
		"name": "addCOO",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "reveal",
				"type": "uint256"
			},
			{
				"name": "placeBlockNum",
				"type": "uint256"
			}
		],
		"name": "settleBet",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "bets",
		"outputs": [
			{
				"name": "amount",
				"type": "uint256"
			},
			{
				"name": "modulo",
				"type": "uint8"
			},
			{
				"name": "placeBlockNumber",
				"type": "uint256"
			},
			{
				"name": "mask",
				"type": "uint40"
			},
			{
				"name": "gambler",
				"type": "address"
			},
			{
				"name": "winAmount",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "kill",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "secretSigner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "jackpotSize",
		"outputs": [
			{
				"name": "",
				"type": "uint128"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "dealFailList",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "betMask",
				"type": "uint256"
			},
			{
				"name": "modulo",
				"type": "uint256"
			},
			{
				"name": "commitLastBlock",
				"type": "uint256"
			},
			{
				"name": "commit",
				"type": "uint256"
			},
			{
				"name": "v",
				"type": "uint8"
			},
			{
				"name": "r",
				"type": "bytes32"
			},
			{
				"name": "s",
				"type": "bytes32"
			}
		],
		"name": "placeBet",
		"outputs": [],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "undealBetNum",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "beneficiary",
				"type": "address"
			},
			{
				"name": "withdrawAmount",
				"type": "uint256"
			},
			{
				"name": "safe",
				"type": "uint8"
			}
		],
		"name": "withdrawFunds",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "dealFailNum",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "maxProfit",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "acceptNextOwner",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_nextOwner",
				"type": "address"
			}
		],
		"name": "approveNextOwner",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "increaseAmount",
				"type": "uint256"
			}
		],
		"name": "increaseJackpot",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "newSecretSigner",
				"type": "address"
			}
		],
		"name": "setSecretSigner",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "cooAddress",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "lockedInBets",
		"outputs": [
			{
				"name": "",
				"type": "uint128"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "commit",
				"type": "uint256"
			}
		],
		"name": "refundBet",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_maxProfit",
				"type": "uint256"
			}
		],
		"name": "setMaxProfit",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"payable": true,
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "commit",
				"type": "uint256"
			},
			{
				"indexed": true,
				"name": "gambler",
				"type": "address"
			},
			{
				"indexed": true,
				"name": "modulo",
				"type": "uint8"
			},
			{
				"indexed": false,
				"name": "mask",
				"type": "uint40"
			},
			{
				"indexed": false,
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "playceBlock",
				"type": "uint256"
			}
		],
		"name": "OnPlaceBet",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "beneficiary",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "FailedPayment",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "beneficiary",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "totalAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "Payment",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "commit",
				"type": "uint256"
			},
			{
				"indexed": true,
				"name": "gambler",
				"type": "address"
			},
			{
				"indexed": true,
				"name": "totalAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "reveal",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "entropy",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "dice",
				"type": "uint256"
			}
		],
		"name": "SettleBetPayment",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"name": "commit",
				"type": "uint256"
			},
			{
				"indexed": true,
				"name": "gambler",
				"type": "address"
			},
			{
				"indexed": true,
				"name": "totalAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "unlockAmount",
				"type": "uint256"
			}
		],
		"name": "LogRefundBet",
		"type": "event"
	}
];

var debugMode = true;//是否为调试模式，调试模式将强制使用本地节点

var MaxEstimateGas = 3700000;//通过多次交易测试后选最大的gas
var contractAddress = null;//;//为null时可以通过deployContract请求来部署
var SecretSigner = {account: "0x25EFe074EC7BA30dE1545caB0f451146bF412b59", privateKeyStr: "0x136a7f64d7401fe43fc5b1339b11b3eb244533a03ec8cd2a03e6770039807c29"};
// var Croupier = "0xeb0e5b3c177c72235d07d8daa6e7ad8fe701e24a";//相当于COO
//代理商信息，第一个代理商同时也是合约发布者
var delegates = [];
// delegates.push({"account":"0xeb0e5b3c177c72235d07d8daa6e7ad8fe701e24a", "latestNonce":-1, "privateKey":new Buffer('a6abcae8af8089b782b90ee864da0912320d31a83306b740d1a843108e8cfa9f', 'hex'), privateKeyStr:'0xa6abcae8af8089b782b90ee864da0912320d31a83306b740d1a843108e8cfa9f'});
// delegates.push({"account":"0xc17f762282149f36f2b26bfee54aa8678b70c3a4", "latestNonce":-1, "privateKey":new Buffer('ef28d75985db54e454ae37882aeb0f8850f35f15c5d42f2c82e8cde277a1f5f0', 'hex'), privateKeyStr:'0xef28d75985db54e454ae37882aeb0f8850f35f15c5d42f2c82e8cde277a1f5f0'});
// delegates.push({"account":"0x5b1b048bac797bd17d5c9eb04e575960ec25ed02", "latestNonce":-1, "privateKey":new Buffer('69a5f349e11d11ca0bc15c53a3b87443d20347daf7ca4ff7d7c286c3e8750391', 'hex'), privateKeyStr:'0x69a5f349e11d11ca0bc15c53a3b87443d20347daf7ca4ff7d7c286c3e8750391'});
// delegates.push({"account":"0x235fea5ea4b0ce72b97430972ef77a8d93956a73", "latestNonce":-1, "privateKey":new Buffer('1F8CAE4D8604D6FE204789EB7430646D59B0BCD8E5C15D801D88273E39AD4978', 'hex'), privateKeyStr:'0x1F8CAE4D8604D6FE204789EB7430646D59B0BCD8E5C15D801D88273E39AD4978'});
// delegates.push({"account":"0xd944e7a9f9bfcf28410e3de204d5cbbab58bac37", "latestNonce":-1, "privateKey":new Buffer('23F6C27FA7E4FBCD8C971B17E6F7FAD9F1A64A3BF06E0588B604C1BA1D2A5E14', 'hex'), privateKeyStr:'0x23F6C27FA7E4FBCD8C971B17E6F7FAD9F1A64A3BF06E0588B604C1BA1D2A5E14'});
// delegates.push({"account":"0x1ccb0a84e2ea1fe3f096a0aa395dce19b00e5f7a", "latestNonce":-1, "privateKey":new Buffer('B38B46DF7AEB71E4879365D3FA2ECE64DEA3F39DF4A809BF908EB70EEF1623EA', 'hex'), privateKeyStr:'0xB38B46DF7AEB71E4879365D3FA2ECE64DEA3F39DF4A809BF908EB70EEF1623EA'});
delegates.push({"account":"0x51e47ef7e922b00d53dc4df4cab3c1e82a0f6346", "latestNonce":-1, "privateKey":new Buffer('b5c2e1890b0448620d83ec37bbb5fc57362a6ab2c08b770753819de155018052', 'hex'), privateKeyStr:'0xb5c2e1890b0448620d83ec37bbb5fc57362a6ab2c08b770753819de155018052'});
delegates.push({"account":"0x61e8977265802f9e44317f25ac3782c6ec433222", "latestNonce":-1, "privateKey":new Buffer('9feec82a7c37c559bf4ec94b9a60224f3ea99ab75e43f7f1b08ba49295c3215e', 'hex'), privateKeyStr:'0x9feec82a7c37c559bf4ec94b9a60224f3ea99ab75e43f7f1b08ba49295c3215e'});
delegates.push({"account":"0x758b85647a129fd0f0f73755edbae00df645d608", "latestNonce":-1, "privateKey":new Buffer('3eeb0a68846a445a097a9d27232332e26d30befaddaf087dcd90bd3f66e07a95', 'hex'), privateKeyStr:'0x3eeb0a68846a445a097a9d27232332e26d30befaddaf087dcd90bd3f66e07a95'});
//-----------------------------------------------
var petContract;
var subContract;

var startWeb3 = async function(cb) {
    var rpcURL;
    //为调试与发布模式强制设置一些值方便测试与提高安全性
    if(debugMode){
			contractAddress = "0x775e7486eb8d3349f87faef3d6903c6358f5580d";
			// contractAddress = "0x74Ae5198A336FA224F0404cd5474d3B004c8886f";
      // contractAddress = "0x4d48bebccb0a4bd8f99a955eaa4470f6796831ea";
      // contractAddress = "0xbc402c35d19bbec48ef64d5c59c42f7b8de27f9a";
      // contractAddress = "0x7fc9cc8410fe8ab9b588d2f95bc21d613fb43718";
      // contractAddress = "0x740b88316c6a3b2738de91cf046c48da746ff0fe"; //2019.5.11
      // contractAddress="0xcb826cb2e45215fdd57552ceecd7369307af6d74"
        // contractAddress="0x1B8356E2EA33aEb90eA80439630E5a07C1678542";
        rpcURL = 'http://localhost:9646';
        // contractAddress="0x5d478631823cef55441bc71e4365a1836d1e4cbd";//t
        // rpcURL = 'http://etzrpc.org:80';//t
    }else{
        contractAddress="0x5137814e854fa10ee6d8ac3ad836d345db6ed44e";
        rpcURL = 'http://localhost:9646';
        // contractAddress="0x5d478631823cef55441bc71e4365a1836d1e4cbd";//t
        // rpcURL = 'http://etzrpc.org:80';//t
    }
    var  _web3 = new Web3(new Web3.providers.HttpProvider(rpcURL));
    // var _web3WS = new Web3(new Web3.providers.WebsocketProvider(_wsProvider));
    eth = _web3.eth;

    //有合约地址则获取合约实例，没有则通过deployContract接口部署，或者setContractAddr接口设置已有合约
    if(contractAddress!=null){
        petContract = new eth.Contract(petContractABI, contractAddress);
        try{
            var maxProfit = await petContract.methods.maxProfit().call();
            console.log(maxProfit);
        }catch(err){
            petContract = null;
            contractAddress = null;
        }
    }
    module.exports.contractAddress = contractAddress;

    //读取区块链上的nonce
    for(var i=0; i<delegates.length; i++){
        delegates[i].latestNonce = await eth.getTransactionCount(delegates[i].account)-1;
        console.log(delegates[i].account,' latestNonce:'+delegates[i].latestNonce);
    }


    module.exports.web3 = _web3;
    module.exports.petContract = petContract;
    module.exports.delegates = delegates;
    console.log('web3 start!');

    cb();
}

module.exports.startWeb3 = startWeb3;
module.exports.debugMode = debugMode;
module.exports.petContractABI = petContractABI;
module.exports.contractBytes = contractBytes;
module.exports.SecretSigner = SecretSigner;
// module.exports.Croupier = Croupier;
module.exports.MaxEstimateGas = MaxEstimateGas;
